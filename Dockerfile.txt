
# Estágio 1: Build (O Canteiro de Obras)
FROM node:22-alpine AS builder

WORKDIR /app

# Instala dependências e ferramentas de build
RUN apk add --no-cache python3 make g++

COPY package*.json ./
RUN npm install

# Copia todo o código fonte
COPY . .

# Gera o build do frontend (React/Vite -> dist)
RUN npm run build

# Estágio 2: Runtime (O Cérebro em Operação)
FROM node:22-alpine

WORKDIR /app

# Instala apenas dependências de produção
COPY package*.json ./
RUN npm install --omit=dev && npm install -g tsx

# Copia os arquivos necessários do estágio de build
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/*.ts ./
COPY --from=builder /app/types.ts ./

# Porta interna do container
EXPOSE 3005

# Inicializa o organismo usando tsx para performance nativa ESM
CMD ["tsx", "server.ts"]
